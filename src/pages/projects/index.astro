---
import { getCollection } from 'astro:content';
import BaseHead from '../../components/BaseHead.astro';
import Footer from '../../components/Footer.astro';
import Header from '../../components/Header.astro';
import ProjectCard from '../../components/ProjectCard.astro';
import { SITE_TITLE } from '../../consts';

const projects = (await getCollection('projects')).sort((a, b) => a.data.order - b.data.order);
const engines = Array.from(new Set(projects.flatMap((project) => project.data.engines))).sort();
const platforms = Array.from(new Set(projects.flatMap((project) => project.data.platforms))).sort();

const pageTitle = `Projects — ${SITE_TITLE}`;
const pageDescription = 'Filterable gallery of game projects showcasing systems design, tooling, and shipped experiences.';
---

<!doctype html>
<html lang="en">
  <head>
    <BaseHead title={pageTitle} description={pageDescription} />
  </head>
  <body>
    <Header />
    <main>
      <section class="projects-hero surface">
        <div class="section-heading">
          <span>Project Gallery</span>
          <h1>Every build. Every lesson.</h1>
        </div>
        <p class="lede">
          MooreThanCode is about clarity of process. Explore shipped games, prototypes, and in-flight concepts—all accompanied by the
          tooling, pipelines, and design evidence that brought them to life.
        </p>
      </section>

      <section class="filter-bar surface">
        <div class="filter-group" data-group="engine">
          <span class="filter-label">Engine</span>
          <div class="filter-options">
            <button type="button" class="filter-chip is-active" data-filter-group="engine" data-filter-value="all" aria-pressed="true">
              All
            </button>
            {engines.map((engine) => (
              <button type="button" class="filter-chip" data-filter-group="engine" data-filter-value={engine} aria-pressed="false">
                {engine}
              </button>
            ))}
          </div>
        </div>
        <div class="filter-group" data-group="platform">
          <span class="filter-label">Platform</span>
          <div class="filter-options">
            <button type="button" class="filter-chip is-active" data-filter-group="platform" data-filter-value="all" aria-pressed="true">
              All
            </button>
            {platforms.map((platform) => (
              <button type="button" class="filter-chip" data-filter-group="platform" data-filter-value={platform} aria-pressed="false">
                {platform}
              </button>
            ))}
          </div>
        </div>
      </section>

      <section class="projects-grid">
        <div class="grid grid--projects" id="projects-grid" data-default-count={projects.length}>
          {projects.map((project) => (
            <ProjectCard
              project={project}
              data-project-card="true"
              data-project-engines={project.data.engines.join(',')}
              data-project-platforms={project.data.platforms.join(',')}
            />
          ))}
        </div>
      </section>
    </main>
    <Footer />

    <script is:inline>
      const filterState = { engine: 'all', platform: 'all' };
      const buttons = document.querySelectorAll('[data-filter-group]');
      const cards = Array.from(document.querySelectorAll('[data-project-card]'));

      const applyFilters = () => {
        cards.forEach((card) => {
          const engines = (card.getAttribute('data-project-engines') || '').split(',');
          const platforms = (card.getAttribute('data-project-platforms') || '').split(',');
          const matchesEngine = filterState.engine === 'all' || engines.includes(filterState.engine);
          const matchesPlatform = filterState.platform === 'all' || platforms.includes(filterState.platform);
          card.toggleAttribute('hidden', !(matchesEngine && matchesPlatform));
        });
      };

      buttons.forEach((button) => {
        button.addEventListener('click', () => {
          const group = button.dataset.filterGroup;
          const value = button.dataset.filterValue;
          if (!group || !value) return;

          if (filterState[group] === value) {
            filterState[group] = 'all';
          } else {
            filterState[group] = value;
          }

          document
            .querySelectorAll(`[data-filter-group="${group}"]`)
            .forEach((btn) => {
              const isActive = btn === button && filterState[group] !== 'all';
              const isAll = btn.dataset.filterValue === 'all' && filterState[group] === 'all';
              btn.classList.toggle('is-active', isActive || isAll);
              btn.setAttribute('aria-pressed', (isActive || isAll).toString());
            });

          applyFilters();
        });
      });
    </script>
  </body>
</html>

<style>
  .projects-hero {
    margin-top: 2.5rem;
    margin-bottom: 3rem;
    padding: 3rem;
    display: flex;
    flex-direction: column;
    gap: 1.75rem;
    background: linear-gradient(135deg, rgba(190, 242, 100, 0.18), rgba(30, 30, 30, 0.95));
  }
  .projects-hero .lede {
    margin: 0;
    font-size: 1.05rem;
    color: rgba(234, 234, 234, 0.9);
    max-width: 760px;
  }
  .filter-bar {
    margin-bottom: 3rem;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 1.5rem;
    padding: 1.75rem;
    background: rgba(30, 30, 30, 0.95);
    border-radius: 24px;
    border: 1px solid rgba(255, 255, 255, 0.06);
  }
  .filter-group {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }
  .filter-label {
    font-size: 0.8rem;
    letter-spacing: 0.4em;
    text-transform: uppercase;
    color: var(--color-muted);
  }
  .filter-options {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }
  .filter-chip {
    padding: 0.5rem 1.1rem;
    border-radius: 999px;
    border: 1px solid rgba(255, 255, 255, 0.12);
    background: transparent;
    color: var(--color-text);
    font-size: 0.85rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    cursor: pointer;
    transition: transform 0.2s ease, background 0.2s ease, border 0.2s ease;
  }
  .filter-chip:hover,
  .filter-chip:focus {
    transform: translateY(-2px);
    border-color: rgba(190, 242, 100, 0.35);
  }
  .filter-chip.is-active {
    background: rgba(190, 242, 100, 0.2);
    border-color: rgba(190, 242, 100, 0.45);
    color: var(--color-text);
  }
  .projects-grid {
    margin-bottom: 4rem;
  }
  @media (max-width: 960px) {
    .projects-hero {
      padding: 2.5rem;
    }
  }
  @media (max-width: 640px) {
    .projects-hero {
      padding: 2rem;
    }
    .filter-bar {
      padding: 1.5rem;
    }
  }
</style>
