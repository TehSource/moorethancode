---
import { type CollectionEntry, getCollection, render } from 'astro:content';
import BaseHead from '../../components/BaseHead.astro';
import Footer from '../../components/Footer.astro';
import Header from '../../components/Header.astro';

export async function getStaticPaths() {
  const projects = await getCollection('projects');
  return projects.map((project) => ({
    params: { slug: project.id },
    props: project,
  }));
}

type ProjectEntry = CollectionEntry<'projects'>;

const project = Astro.props as ProjectEntry;
const { Content } = await render(project);
const heroMedia = project.data.heroMedia ?? project.data.cardMedia;
const lessons = project.data.lessons ?? [];
const ctas = [
  project.data.cta?.play && { label: 'Play Game', href: project.data.cta.play },
  project.data.cta?.itch && { label: 'View on Itch.io', href: project.data.cta.itch },
  project.data.cta?.code && { label: 'See Code', href: project.data.cta.code },
].filter(Boolean) as { label: string; href: string }[];

const pageTitle = `${project.data.title} â€” Case Study`;
---

<!doctype html>
<html lang="en">
  <head>
    <BaseHead title={pageTitle} description={project.data.description} />
  </head>
  <body>
    <Header />
    <main>
      <article class="project-case">
        <header class="project-hero">
          {heroMedia?.type === 'video' ? (
            <video
              src={heroMedia.src}
              poster={heroMedia.poster ? heroMedia.poster.src : undefined}
              autoplay
              muted
              loop
              playsinline
            />
          ) : null}
          <div class="hero-meta surface">
            <div>
              <span class="pill">{project.data.genre}</span>
              <h1>{project.data.title}</h1>
              <p>{project.data.description}</p>
            </div>
            {ctas.length ? (
              <div class="hero-cta">
                {ctas.map((cta) => (
                  <a class="button" href={cta.href} target="_blank" rel="noreferrer">
                    {cta.label}
                  </a>
                ))}
              </div>
            ) : null}
          </div>
        </header>

        <section class="project-details">
          <aside class="project-summary surface">
            <h2>Quick Info</h2>
            <dl>
              <div>
                <dt>Status</dt>
                <dd>{project.data.status}</dd>
              </div>
              <div>
                <dt>Role</dt>
                <dd>{project.data.role}</dd>
              </div>
              <div>
                <dt>Engine</dt>
                <dd>{project.data.engines.join(', ')}</dd>
              </div>
              <div>
                <dt>Platform</dt>
                <dd>{project.data.platforms.join(', ')}</dd>
              </div>
              <div>
                <dt>Tech Stack</dt>
                <dd>{project.data.tech.join(', ')}</dd>
              </div>
            </dl>
          </aside>

          <div class="project-content surface">
            <h2>Development Highlights</h2>
            <Content />

            {lessons.length ? (
              <section class="lessons">
                <h3>Lessons Learned</h3>
                <ul>
                  {lessons.map((lesson) => (
                    <li>{lesson}</li>
                  ))}
                </ul>
              </section>
            ) : null}
          </div>
        </section>
      </article>
    </main>
    <Footer />
  </body>
</html>

<style>
  .project-case {
    display: flex;
    flex-direction: column;
    gap: 4rem;
  }
  .project-hero {
    display: grid;
    gap: 2rem;
  }
  .project-hero video {
    width: 100%;
    aspect-ratio: 16 / 9;
    border-radius: 24px;
    box-shadow: var(--shadow-soft);
  }
  .hero-meta {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    padding: 2.5rem;
  }
  .hero-meta h1 {
    font-size: clamp(2.4rem, 5vw, 3.4rem);
  }
  .hero-cta {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
  }
  .project-details {
    display: grid;
    gap: 2.5rem;
    grid-template-columns: 320px 1fr;
    align-items: start;
  }
  .project-summary {
    position: sticky;
    top: 7rem;
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    padding: 2rem;
  }
  .project-summary dl {
    margin: 0;
    display: grid;
    gap: 1.25rem;
  }
  .project-summary dt {
    font-size: 0.75rem;
    letter-spacing: 0.4em;
    text-transform: uppercase;
    color: var(--color-muted);
  }
  .project-summary dd {
    margin: 0;
    font-size: 1.05rem;
    color: var(--color-text);
  }
  .project-content {
    display: flex;
    flex-direction: column;
    gap: 2rem;
    padding: 3rem;
  }
  .project-content h2 {
    margin-bottom: 1rem;
  }
  .project-content :global(p) {
    color: rgba(234, 234, 234, 0.9);
  }
  .project-content :global(ul) {
    margin-left: 1.5rem;
  }
  .lessons ul {
    list-style: disc;
    margin-left: 1.5rem;
  }
  .lessons li {
    margin-bottom: 0.75rem;
  }
  @media (max-width: 1024px) {
    .project-details {
      grid-template-columns: 1fr;
    }
    .project-summary {
      position: static;
      order: 2;
    }
  }
  @media (max-width: 640px) {
    .hero-meta {
      padding: 2rem;
    }
    .project-summary {
      padding: 1.75rem;
    }
    .project-content {
      padding: 2.5rem 1.75rem;
    }
  }
</style>
